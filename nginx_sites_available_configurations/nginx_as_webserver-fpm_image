# This upstream block defines the location of your PHP-FPM service.
# Replace 'enter_your_domain-wordpress' with a descriptive name for your service.
upstream enter_your_domain-wordpress {
  # This is the IP and port of your PHP-FPM container.
  server 127.0.0.1:enter_wordpress_port;
}

# This server block listens on port 80 and redirects all HTTP traffic to HTTPS.
server {
  listen 80;
  server_name enter_your_domain;

  # This security check ensures that only requests for your domain are processed.
  if ($host != "enter_your_domain") {
    return 403;
  }

  return 301 https://$host$request_uri;
}

# This is the main server block for handling HTTPS traffic.
server {
  listen 443 ssl http2;
  server_name enter_your_domain;

  # Another security check for HTTPS.
  if ($host != "enter_your_domain") {
    return 403;
  }

  # The 'root' directive MUST point to the full path of your website's files
  # on the host machine's filesystem.
  # ex. /opt/mywebsite/data/wordpress
  root enter_path_to_wordpress_data;
  index index.php index.html index.htm;

  # SSL configuration, replace these with your own certificate paths.
  ssl_certificate         /etc/letsencrypt/live/enter_your_domain/fullchain.pem;
  ssl_certificate_key     /etc/letsencrypt/live/enter_your_domain/privkey.pem;
  include                 /etc/letsencrypt/options-ssl-nginx.conf;
  ssl_dhparam             /etc/letsencrypt/ssl-dhparams.pem;

  # Proxy logs, adjust the path and filename as needed.
  access_log      /var/log/nginx/enter_your_domain.access.log;
  error_log       /var/log/nginx/enter_your_domain.error.log;

  # This location block is the default catch-all for all non-specific requests.
  location / {
    # Tries to find the file, then directory, then falls back to index.php.
    try_files $uri $uri/ /index.php?$args;
  }

  # This location block handles all PHP files by passing them to PHP-FPM.
  location ~ \.php$ {
    try_files $uri =404;

    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    # This must match the name of the upstream block defined at the top.
    fastcgi_pass enter_your_domain-wordpress;
    fastcgi_index index.php;
    include fastcgi_params;

    # The SCRIPT_FILENAME MUST be the path to the website's files [IMPORTANT!!!]
    # as seen from INSIDE the Docker container's filesystem.
    # The default for wordpress is '/var/www/html'
    fastcgi_param SCRIPT_FILENAME /var/www/html$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
  }

  # Global restrictions for security.
  location ~ /\. {
    deny all;
  }

  location ~* /(?:uploads|files)/.*\.php$ {
    deny all;
  }
}
